---
description: Architecture conventions
---

- Plugin runtime dependencies must live in dependencies section of plugin package.json - npm install runs with --omit=dev in plugin dir
- In multi-account channel code, always thread `accountId` through every resolution path â€” config resolution, client lookup, auth resolution, credential storage, shared client creation, and outbound send functions. Failing to propagate accountId at any point causes silent fallback to the default/wrong account, which can send messages from the wrong bot identity.
- When using identifier keys (like accountId) for Map-based storage, config lookups, and credential file naming, normalize the identifier early using a shared `normalizeAccountId()` function. Use case-insensitive fallback for config key lookups (direct lookup first, then iterate keys with normalization). Deduplicate normalized keys (via Set) before returning lists to prevent starting the same logical account twice.
- When adding multi-account support to a channel plugin, follow the same pattern already used by the WhatsApp channel: read account configs from `channels.<channel>.accounts`, use Map-based client storage keyed by accountId (instead of singletons), support per-account config with fallback to top-level defaults, and maintain backward compatibility with single-account setups.
