---
description: Critical anti-patterns — things that WILL cause problems if ignored
---

- When user says "push", may git pull --rebase to integrate latest changes (never discard other agents' work); when user says "commit", scope to your changes only; when user says "commit all", commit everything in grouped chunks (AGENTS.md Multi-agent safety section specifies commit/push behavior in multi-agent context)
- NEVER commit local config files (`.tmp/**`, `openclaw.json` snapshots) that contain live `gateway.auth.token` values or machine-specific absolute paths — these leak reusable secrets into repository history and bake in developer-local paths. Add `.tmp/` to .gitignore and rotate any leaked tokens immediately. (caught in PR #15715 — flagged by both Greptile and Codex reviewers independently) (A WIP PR committed .tmp/dev/openclaw.json containing a live gateway.auth.token and machine-specific )
- Avoid manual git add / git commit - use scripts/committer "<msg>" <file...> to keep staging scoped (AGENTS.md Commit & Pull Request Guidelines requires using committer script for scoped staging)
- Avoid workspace:* in plugin dependencies (npm install breaks) - put openclaw in devDependencies or peerDependencies instead (AGENTS.md Project Structure warns workspace:* breaks npm install in plugins)
- Avoid adding plugin-only dependencies to root package.json - they must live in the extension package.json unless core uses them (AGENTS.md Project Structure specifies plugin deps must stay scoped to extension package.json)
- Avoid using any type in TypeScript - prefer strict typing (AGENTS.md Coding Style & Naming Conventions prefers strict typing over any)
- Do NOT switch branches or check out a different branch unless explicitly requested (AGENTS.md Multi-agent safety rules prevent branch switching to avoid confusion between agents)
- Do NOT create/remove/modify git worktree checkouts (or edit .worktrees/*) unless explicitly requested (AGENTS.md Multi-agent safety rules prohibit worktree modifications to avoid conflicts)
- Do NOT create/apply/drop git stash entries unless explicitly requested (includes git pull --rebase --autostash) - assume other agents may be working (AGENTS.md Multi-agent safety rules prohibit stashing to avoid cross-agent interference)
- Do NOT introduce new ObservableObject usage in SwiftUI - prefer Observation framework (@Observable, @Bindable) and migrate existing usages when touching related code (AGENTS.md Agent-Specific Notes requires modern Observation framework over ObservableObject in SwiftU)
- Do NOT commit or publish real phone numbers, videos, or live configuration values - use obviously fake placeholders in docs, tests, and examples (AGENTS.md Security & Configuration Tips prohibits publishing real sensitive data)
- Do NOT edit docs/zh-CN/** unless explicitly asked - it is generated (AGENTS.md Docs i18n section specifies zh-CN docs are generated)
- Do NOT set test workers above 16 (already tried) (AGENTS.md Testing Guidelines prohibits >16 test workers (already attempted))
- NEVER update the Carbon dependency (AGENTS.md Agent-Specific Notes prohibits updating Carbon dependency)
- NEVER edit node_modules (global/Homebrew/npm/git installs too) - updates will overwrite changes (AGENTS.md Agent-Specific Notes prohibits editing node_modules because updates overwrite)
- NEVER embed "\n" in GitHub issues/comments/PR comments - use literal multiline strings or `-F - <<'EOF'` (or $'...') for real newlines (AGENTS.md Repository Guidelines section requires literal newlines in GitHub API interactions)
- NEVER delete only the first legacy key match during session store migration — delete ALL case-variant legacy keys in a single pass using `findStoreKeysIgnoreCase()`. Deleting only one leaves ghost duplicates behind, causing sessions.list to show phantom entries. This applies to all write paths: agent handlers, node-events, and sessions handlers. (caught in PRs #12846 — repeated across multiple files: sessions-resolve.ts, agent.ts, server-node-events.ts) (Multiple write paths (agent, node-events, sessions) only deleted the first legacy case-variant key, )
- NEVER use raw `.toLowerCase()` to canonicalize session keys or identifiers — use the dedicated canonicalization functions (`canonicalizeSpawnedByForAgent()`, `resolveSessionStoreKey()`, etc.). Raw lowercasing bypasses sentinel handling (`global`/`unknown`), the `agent:` prefix logic, bare name normalization, and the `main` alias mapping, causing session key mismatches and ghost sessions. Before: `spawnedByValue = spawnedByValue.toLowerCase()`. After: `spawnedByValue = canonicalizeSpawnedByForAgent(agentId, spawnedByValue, cfg)`. (caught in PR #12846 — multiple comments on this pattern) (PR author used raw .toLowerCase() to normalize session keys in agent.ts instead of the canonical ses)
- Do NOT ignore unexpected changes to src/canvas-host/a2ui/.bundle.hash - it is auto-generated; only regenerate via pnpm canvas:a2ui:bundle or scripts/bundle-a2ui.sh when needed and commit hash as separate commit (AGENTS.md Agent-Specific Notes specifies handling of A2UI bundle hash)
- Control UI uses Lit with legacy decorators - use @state() foo = "bar" and @property({ type: Number }) count = 0 style; avoid flipping experimentalDecorators or useDefineForClassFields unless updating build tooling (CONTRIBUTING.md Control UI Decorators section requires legacy decorator style due to Rollup parsing )
- Always read docs/reference/RELEASING.md and docs/platforms/mac/release.md before any release work - do not ask routine questions once those docs answer them (AGENTS.md Security & Configuration Tips requires reading release docs before release work)
- NEVER return timeout/null decisions as successful responses — callers cannot distinguish between "timed out" and "explicitly allowed/denied." When an async operation resolves to `null` due to timeout, return an explicit error or a distinct status field (e.g., `{ status: "timeout", decision: null }`) rather than `respond(true, { decision: null })`. Ensure all API endpoints that wait for async decisions have consistent timeout semantics. (caught in PR #3357 — exec approval timeout handling, flagged multiple times across review rounds) (exec.approval.request returned {decision: null} on timeout as a success response, while exec.approva)
- Use src/cli/progress.ts (osc-progress + @clack/prompts spinner) for CLI progress - don't hand-roll spinners/bars (AGENTS.md Agent-Specific Notes requires using standard progress utilities for CLI)
- NEVER allow `register()` or similar Map-based pending-entry methods to silently overwrite existing entries with the same ID — this strands the original request's promise/timer and can deliver decisions to the wrong waiter. Always guard with an existence check: return the existing entry's promise if the ID is already registered, or throw an explicit error. Wrap `register()` calls in try/catch so thrown errors produce structured responses instead of unhandled exceptions. (caught in PR #3357 — exec approval manager, multiple review rounds) (ExecApprovalManager.register() unconditionally overwrote pending Map entries, stranding original pro)
- NEVER commit `package-lock.json` in this repository — the project uses pnpm and relies on `pnpm-lock.yaml`. Adding an npm lockfile creates conflicting dependency sources and CI drift. If `package-lock.json` appears, it was generated accidentally by running `npm install` instead of `pnpm install`. (caught in PR #15715) (A PR added a 14k-line package-lock.json to a pnpm-managed repo, creating conflicting lockfiles. Revi)
- NEVER normalize identifiers (account IDs, keys) without deduplicating the result — if config contains keys like `Assistant` and `assistant` that normalize to the same value, the system will attempt to start the same logical entity twice, causing Map collisions, credential overwrites, and runtime crashes. Always pass normalized results through a `Set` or equivalent dedup step. (caught in PR #7286 — Matrix account ID normalization) (listConfiguredAccountIds() normalized account keys but didn't deduplicate, so config keys 'Assistant)
- NEVER use shallow object spread (`{ ...base, ...override }`) to merge config objects with nested fields — per-account or per-feature overrides will silently replace entire nested objects instead of merging individual fields. Example: base `dm: { policy: "pairing", allowFrom: [...] }` + account override `dm: { allowFrom: [...] }` drops `policy` entirely. Use a deep merge utility or explicitly merge each nested key. (caught in PR #7286 — Matrix multi-account config merge) (Matrix multi-account config used shallow spread to merge per-account overrides with base config, sil)
- Dependency patching policy: Any dependency with pnpm.patchedDependencies must use an exact version (no ^/~). Patching dependencies (pnpm patches, overrides, or vendored changes) requires explicit approval; do not do this by default. Never update the Carbon dependency. (AGENTS.md agent-specific notes specify dependency patching guardrails and Carbon exception)
- Multi-agent safety: Do NOT create/apply/drop git stash entries, create/remove/modify git worktree checkouts, or switch branches unless explicitly requested. When the user says "commit", scope to your changes only; "commit all" means grouped chunks. Focus reports on your edits; continue if safe when multiple agents touch the same file. (AGENTS.md multi-agent safety section establishes git operation boundaries when multiple agents colla)
- Tool schema constraints: Avoid Type.Union in tool input schemas (no anyOf/oneOf/allOf). Use stringEnum/optionalStringEnum (Type.Unsafe enum) for string lists, and Type.Optional(...) instead of | null. Keep top-level tool schema as type: "object" with properties. Avoid raw 'format' property names as some validators treat it as reserved. (AGENTS.md tool schema guardrails section specifies TypeBox patterns for LLM tool compatibility)
- Documentation linking rules (Mintlify): Internal doc links in docs/**/*.md must be root-relative without .md/.mdx extension (e.g., [Config](/configuration)). Section cross-references use anchors on root-relative paths (e.g., [Hooks](/configuration#hooks)). Avoid em dashes and apostrophes in headings because they break Mintlify anchor links. (AGENTS.md docs linking section specifies Mintlify-specific link format and heading constraints)
- When answering questions, respond with high-confidence answers only - verify in code; do not guess (AGENTS.md Agent-Specific Notes requires verifying answers in code rather than guessing)
- NEVER include API-specific payload fields unconditionally — gate optional fields on the relevant type/mode. Example: Discord's `url` field in activity payloads is only valid for `type: 1` (Streaming); including it for other activity types causes the presence payload to be rejected or silently ignored. Always check `activityType === 1` before including `url`. (caught in PR #10855 — Discord presence configuration) (Discord presence update always included the url field in activity payloads regardless of activity ty)
- NEVER sanitize identifiers into filenames using simple character replacement (e.g., replacing non-alphanumeric chars with `_`) — distinct identifiers can collapse to the same filename (e.g., `a:b` and `a?b` both become `credentials-a_b.json`), causing credential overwrites and cross-account data leaks. Use collision-resistant encoding such as base64url or append a short hash suffix. (caught in PR #7286 — Matrix credential filenames) (Matrix credentialsFilename() replaced non-alphanumeric chars with _ to sanitize account IDs, but thi)
- Group related changes in commits - avoid bundling unrelated refactors (AGENTS.md Commit & Pull Request Guidelines requires grouping related changes)
- Pure test additions/fixes generally do not need a changelog entry unless they alter user-facing behavior (AGENTS.md Testing Guidelines clarifies when test changes need changelog entries)
- Do not leave unused variables in code, including test files. CI enforces a no-unused-variables rule (likely via TypeScript's `noUnusedLocals` or a linter). If a variable is declared but never read or asserted against, remove it — CI will fail on this even in test code. (CI 'checks-windows' test check failed because an unused variable `callCount` was declared in threadi)
- When using a module-level mutex/lock to serialize async operations (e.g., dynamic imports), always release the lock in a `try/finally` block to prevent deadlocks if the locked operation throws. Never leave lock release dependent on successful completion only. (Reviewer flagged that the startup mutex for serializing dynamic imports could deadlock if the import)
- In the exec approval manager, use a two-phase approval flow: register the approval synchronously (with `expectFinal: false`) to get an immediate "accepted" response confirming the approval ID, then use a separate `waitDecision` call to await the actual decision. Do not rely on dual-response from a single call. (PR author (ramin-shirali) explicitly explained the two-phase approval design in a review comment: "T)
- In gateway server method handlers, wrap calls that can throw (like manager.register()) in try/catch and respond with a structured errorShape(ErrorCodes.INVALID_REQUEST, ...) error. Never let exceptions propagate to the transport layer as unstructured errors. (Reviewer flagged that manager.register() could throw on duplicate IDs but the handler had no try/cat)
- When using `HttpsProxyAgent` from the `https-proxy-agent` package for Discord gateway proxy connections, note that despite its name, it supports `http`, `https`, and `socks5h` proxy schemes. Do not replace it with a different agent solely based on the URL scheme. (Bot reviewer flagged a potential proxy scheme mismatch with HttpsProxyAgent. PR author winter-loo cl)
- When the same path-resolution or validation logic is needed across multiple call sites, extract it into a shared helper function (e.g., in a dedicated `paths.ts` utility file) and reuse it to ensure consistent behavior. Do not duplicate path validation logic inline across different modules. (After fixing a regression caused by inconsistent session-path validation across modules, the author )
